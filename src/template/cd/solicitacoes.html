{% extends 'cd/index.html' %}

{% block title.content %}{{ titulo }} - {{ block.super }}{% endblock title.content %}
{% block header.content %}{{ titulo }} - <a href="{% url 'cd:index' %}">{{ block.super }}</a>{% endblock header.content %}

{% block stylesheet %}
<style>
{% include 'layout/simple_table.css' %}

thead th
{
  position: sticky;
  top: 0px;
}

</style>
{% endblock %}

{% block content %}
{% if msg_erro %}
  <h3>{{ msg_erro }}</h3>
{% endif %}
{% if form %}
  <p><a title="Listar" href="{% url 'cd:solicitacoes' %}"><span class="glyphicon glyphicon-list" style="font-size: 2em" aria-hidden="true"></span></a></p>
  {% if id %}
    <h2>Edita Solicitação</h2>
    <form action="{% url 'cd:solicitacoes' id %}" method="post">
  {% else %}
    <h2>Adiciona Solicitação</h2>
    <form action="{% url 'cd:solicitacoes' 'add' %}" method="post">
  {% endif %}
  {% csrf_token %}
  {{ form.as_p }}
  {% if id %}
    <input type="submit" value="Grava"/>
  {% else %}
    <input type="submit" value="Adiciona"/>
  {% endif %}
  </form>
  {% if hdata %}
    <h4>Histórico</h4>
    <table>
      {% include "layout/thead_generic.html" with data=hheaders style=hstyle only %}
      {% include "layout/tbody_generic.html" with fields=hfields data=hdata safe=hsafe style=hstyle only %}
    </table>
  {% endif %}
{% else %}
  {% if add_solicita %}
    <p><a title="Inserir" href="{% url 'cd:solicitacoes' 'add' %}"><span class="glyphicon glyphicon-plus-sign" style="font-size: 2em" aria-hidden="true"></span></a></p>
  {% endif %}
  <form action="{% url 'cd:solicitacoes' %}" method="post">
    {% csrf_token %}
    {{ filter.as_p }}
    <input type="submit" value="Busca"/>
  </form>
{% endif %}
{% if data %}
  {% if ref %}
    <h4>Referência: {{ref}}</h4>
  {% endif %}
  <table>
    <thead>
      <tr>
        {% if change_solicita %}
          <th>
            &nbsp;
          </th>
        {% endif %}
        {% for field in fields %}
          {% if field == 'total_qtd' or field == 'total_no_cd' %}
            <th style="text-align: right;">
          {% elif field == 'ativa' or field == 'concluida' or field == 'can_print' or field == 'coleta' %}
            <th style="text-align: center;">
          {% else %}
            <th>
          {% endif %}
            {{headers|get_item:field}}
          </th>
        {% endfor%}
      </tr>
    </thead>
    <tbody>
      {% for row in data %}
        <tr>
          {% if change_solicita %}
            <td>
              <a title="Editar" href="{% url 'cd:solicitacoes' row.id %}"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a>
            </td>
          {% endif %}
          {% for field in fields %}
              {% if field == 'total_qtd' or field == 'total_no_cd' %}
                <td style="text-align: right;">
              {% elif field == 'ativa' or field == 'concluida' or field == 'can_print' or field == 'coleta' %}
                <td style="text-align: center;">
              {% else %}
                <td>
              {% endif %}
              {% if field == 'ativa' %}
                {% if row.ativa %}
                  <span class="glyphicon glyphicon-ok-circle" style="color: green" aria-hidden="true"></span>
                {% else %}
                  <span class="glyphicon glyphicon-remove-circle" style="color: darkred" aria-hidden="true"></span>
                {% endif %}
              {% elif field == 'concluida' %}
                {% if row.concluida %}
                  <span class="glyphicon glyphicon-ok-circle" style="color: green" aria-hidden="true"></span>
                {% else %}
                  <span class="glyphicon glyphicon-remove-circle" style="color: darkred" aria-hidden="true"></span>
                {% endif %}
              {% elif field == 'can_print' %}
                {% if row.can_print %}
                  <span class="glyphicon glyphicon-ok-circle" style="color: green" aria-hidden="true"></span>
                {% else %}
                  <span class="glyphicon glyphicon-remove-circle" style="color: darkred" aria-hidden="true"></span>
                {% endif %}
              {% elif field == 'coleta' %}
                {% if row.coleta %}
                  <span id="span_{{row.num}}" class="glyphicon glyphicon-ok-circle" style="color: green" aria-hidden="true"></span>
                {% else %}
                  <span id="span_{{row.num}}" class="glyphicon glyphicon-remove-circle" style="color: darkred" aria-hidden="true"></span>
                {% endif %}
                {% if row.concluida %}
                  {% if change_solicita or libera_coleta %}
                    <a title="Altera liberação de coleta"
                      onclick="javascript:return ChangeFunction('{{row.num}}');"
                      ><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></a>
                  {% endif %}
                {% endif %}
              {% else %}
                {% with field|add:'|LINK' as field_link %}
                  {% if row|get_item:field_link %}
                    <a href="{{ row|get_item:field_link }}">{{row|get_item:field}}</a>
                  {% else %}
                    {{row|get_item:field}}
                  {% endif %}
                {% endwith %}
              {% endif %}
            </td>
          {% endfor%}
        </tr>
      {% endfor%}
    </tbody>
  </table>

  <script >
    var glyph = '<span id="span_{id}" class="glyphicon glyphicon-{tipo}" '+
                ' style="color: {cor}"  aria-hidden="true"></span>';

    var glyph_ok0  = glyph.replace('{tipo}', 'ok-circle');
    var glyph_ok  = glyph_ok0.replace('{cor}', 'green');
    var glyph_no0  = glyph.replace('{tipo}', 'remove-circle');
    var glyph_no  = glyph_no0.replace('{cor}', 'darkred');

    function ChangeFunction(id) {
      $.ajax({
        type: 'GET',
        url: '/cd/ajax/libera_coleta_de_solicitacao/'+id+'/',
        data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
        success : function(data) {
          if (data) {
            if (data['result'] == 'OK') {
              console.log('OK! '+data['state']);

              span_el = document.querySelectorAll('#span_'+id);
              for (var i=0, len=span_el.length|0; i<len; i=i+1|0) {
                if (span_el[i].outerHTML.indexOf('remove-circle') != -1) {
                  glyph_id = glyph_ok.replace(/\{id\}/g, id);
                } else {
                  glyph_id = glyph_no.replace(/\{id\}/g, id);
                }
                span_el[i].outerHTML = glyph_id;
              }

            } else {
              console.log('Erro: '+data['descricao_erro']);
            }
          } else {
            console.log('Sem retorno de pedido');
          }
        },
        error : function(data) {
          console.log('Erro na requisição');
        }
      });

    }

  </script>
{% endif %}
{% endblock content %}
