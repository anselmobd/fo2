{% extends 'cd/index.html' %}

{% block title.content %}{{ titulo }} - {{ block.super }}{% endblock title.content %}
{% block header.content %}{{ titulo }} - <a href="{% url 'cd:index' %}">{{ block.super }}</a>{% endblock header.content %}

{% block stylesheet %}
  <style>
    {% include 'layout/simple_table.css' %}
    {% include "layout/paginator_stylesheet.css" %}
  </style>
{% endblock %}

{% block content %}
  <div class="noprint">
    <form action="{% url 'cd:novo_estoque' %}" method="post" name="myForm">
      {% csrf_token %}
      {% include "layout/form_field_control.html" with form=form only %}
      <input type="submit" name="busca" value="Busca" onclick="o2SetPage1AndSubmit()"/>
    </form>
  </div>
  {% if erro %}
    <h4>{{ erro }}</h4>
  {% endif %}
  <p>Seleções com '*' são as utilizadas na tela de disponibilidade.<br/>
    Empenhos com OC diferente de '0'; GRUPO_DESTINO diferente de '0'; e
    Situação igual a 1(A confirmar), 2(Confirmado), 3(Programado) ou 4(Solicitado)</p>
  {% if request.POST %}
    {% include "layout/form_inputs_report.html" with form=form h=4 only %}
    {% if data %}
      <h4>{{len_lotes}} lote{{len_lotes|pluralize}} encontrado{{len_lotes|pluralize}}</h4>
      {% include "layout/paginator.html" with data=data url_name='cd:novo_estoque' only %}
        <table>
          {% include "layout/thead_generic.html" with data=headers safe=safe style=style thclass='sticky' only %}
          {% include "layout/tbody_generic.html" with fields=fields data=data safe=safe style=style only %}
        </table>
      {% include "layout/paginator.html" with data=data url_name='cd:novo_estoque' only %}
    {% else %}
      <h4>Nenhum lote encontrado</h4>
    {% endif %}
  {% endif %}
  {% if r_data %}
    <hr>
    <h4>Teste de nova rotina abaixo (até 100 registros)</h4>
    <table>
      {% include "layout/thead_generic.html" with data=r_headers safe=r_safe style=r_style thclass='sticky' only %}
      {% include "layout/tbody_generic.html" with fields=r_fields data=r_data safe=r_safe style=r_style only %}
    </table>
  {% endif %}
{% endblock content %}

{% block javascript %}
  <script type="text/javascript">
    {% include "layout/paginator_javascript.js" with form='myForm' field='page' only %}

    var select_sum = document.querySelector("#select_sum");
    var select_values = document.querySelectorAll(".select_value");
    select_values.forEach((select_value) => {
      select_value.addEventListener(
        "click",
        function (event) {
          let el = event.target;
          let el_parent = el.parentNode;
          let el_marks = el_parent.querySelectorAll(".select_mark")
          if (el.innerHTML.startsWith("+")) {
            el.innerHTML = el.innerHTML.slice(1);
            el_parent.style = "font-weight: normal;";
            el_marks.forEach((el)=>{
              el.innerHTML = el.innerHTML.slice(1, -1);
            })
            select_sum.innerHTML = parseInt(select_sum.innerHTML) - parseInt(el.innerHTML);
          } else {
            select_sum.innerHTML = parseInt("0" + select_sum.innerHTML) + parseInt(el.innerHTML);
            el.innerHTML = "+" + el.innerHTML;
            el_parent.style = "font-weight: bold;";
            el_marks.forEach((el)=>{
              el.innerHTML = "{" + el.innerHTML + "}";
            }) 
          }
          if (select_sum.innerHTML == '0') {
            select_sum.innerHTML = "";
          }
        }
      );
    });

</script>
{% endblock %}
