{% extends 'email_signature/index.html' %}

{% block title.content %}Contas - {{ block.super }}{% endblock title.content %}
{% block header.content %}Contas - <a href="{% url 'email_signature:index' %}">{{ block.super }}</a>{% endblock header.content %}

{% block stylesheet %}
  <style>
    {% include 'layout/simple_table.css' %}
  </style>
{% endblock %}

{% block content %}
  <p>
    <div>
      <a title="Adiciona uma conta" href="{% url 'email_signature:account_add' %}"><span class="glyphicon glyphicon-plus-sign" style="font-size: 2em" aria-hidden="true"></span></a>
    </div>
  </p>
  {%if accounts%}
  <table>
    <thead>
      <tr>
        <th>
          Conta
        </th>
        <th style="text-align: right;">
            Gerar
        </th>
      </tr>
    </thead>
    <tbody>
      {%for account in accounts%}
      <tr>
        <td>
          <a title="Edita" href="{% url 'email_signature:account_change' account.id %}">{{account}}</a>
        </td>
        <td style="text-align: right;">
          <!-- <a title="Gera" href="{% url 'email_signature:gerar_assinaturas' account.id %}"><span class="glyphicon glyphicon-save-file" aria-hidden="true"></span></a>- -->
          {%if account.state == 'R'%}
            <span id="mess_{{account.id}}"></span>
            <a title="Gera" href="#" onclick="javascript:return GeraAssin('{{account.id}}');"><span id="icone_{{account.id}}" class="glyphicon glyphicon-save-file" aria-hidden="true"></span></a>
          {%else%}
            <span class="glyphicon glyphicon-save-file" style="color: darkgreen;" aria-hidden="true"></span>
          {%endif%}
        </td>
      </tr>
      {%endfor%}
    </tbody>
  </table>
  {%else%}
    Nenhuma
  {%endif%}
{% endblock %}

{% block javascript %}
  <script>
    function GeraAssin(id) {
      $.ajax({
        type: 'GET',
        url: '/email_signature/ajax/gerar_assinatura/'+id+'/',
        data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
        success : function(data) {
          var result = 'Sem retorno'
          var cor = 'black'
          if (data) {
            result = data['result']
            if (result == 'OK') {
              console.log('OK!');
              result = 'Gerada'
              cor = 'darkgreen'
            } else {
              console.log('Erro: '+data['descricao_erro']);
              result = 'Erro: '+data['descricao_erro']
              cor = 'darkred'
            }
          } else {
            console.log('Sem retorno de pedido');
          }
          span_el = document.querySelector('#mess_'+id);
          span_el.innerHTML=result;
          span_el = document.querySelector('#icone_'+id);
          span_el.style.color=cor;
          span_el.title=result;
        },  // success
        error : function(data) {
          console.log('Erro na requisição');
          var result = 'Erro na requisição'
          var cor = 'black'
          span_el = document.querySelector('#mess_'+id);
          span_el.innerHTML=result;
          span_el = document.querySelector('#icone_'+id);
          span_el.style.color=cor;
          span_el.title=result;
        }  // error
      });  // ajax
    }  // function
  </script>
{% endblock %}
