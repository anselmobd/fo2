{% extends 'insumo/index.html' %}

{% block title.content %}{{ titulo }} - {{ block.super }}{% endblock title.content %}
{% block header.content %}{{ titulo }} - <a href="{% url 'insumo:index' %}">{{ block.super }}</a>{% endblock header.content %}

{% block stylesheet %}
<style>
{% include 'layout/simple_table.css' %}
</style>
{% endblock %}

{% block content %}
<h3 style="color: red;">Em desenvolvimento...</h3>
<form action="{% url 'insumo:mapa_por_sem' %}" method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <input type="submit" value="Busca"/>
</form>
{% if periodo_ini %}
  <h3>Periodo: {{ periodo|safe }} (segunda{{ qtd_semanas|pluralize }}-feira{{ qtd_semanas|pluralize }}: {{ periodo_ini }}{% if periodo_ini != periodo_fim %} - {{ periodo_fim }}{% endif %})</h3>
{% endif %}
{% if msg_erro %}
  <h3>{{ msg_erro }}</h3>
{% endif %}
{% if refs %}
  {% for ref in refs %}
    - {{ ref }}</br>
    <!-- { % include "insumo/mapa_sem_ref.html" with ref=ref only %} -->
  {% endfor %}
  <h4>Table</h4>
  <table>
    <thead id="threfs">
    <tr>
    <th>
    ReferÃªncias
    </th>
    </tr>
    </thead>
    <tbody id="tbrefs">
    </tbody>
  </table>
  <h4>Din. Table</h4>
  <table>
    <tbody id="dtbrefs">
    </tbody>
  </table>
{% endif %}
{% endblock %}

{% block javascript %}
<script type="text/javascript">

  function sleep(milliseconds) {
    var start = new Date().getTime();
    for (var i = 0; i < 1e7; i++) {
      if ((new Date().getTime() - start) > milliseconds){
        break;
      }
    }
  }

  var refs = [
    {% for ref in refs %}
      {% if forloop.counter > 1 %}, {% endif %}'{{ ref }}'
    {% endfor %}
  ];

  var tbRefs = document.getElementById('tbrefs');

  for (var i = 0, l = refs.length; i < l; i++) {
    // alert(refs[i]);
    tr = document.createElement('tr');
    tr.id = 'ref_'+refs[i];

    td = document.createElement('td');
    td.classList.add('field_ref');
    text = document.createTextNode(refs[i]);
    td.appendChild(text);
    tr.appendChild(td);

    td = document.createElement('td');
    td.classList.add('field_data');
    tr.appendChild(td);

    tbRefs.appendChild(tr);

  }

  $("input#id_periodo").on('change keyup paste', function () {
    console.log( $(this).val() );
  });

  var dtbRefs = document.getElementById('dtbrefs');
  var iRefAjax = 0;

  function doAjax1Ref() {
    $.ajax({
      type: 'GET',
      url: '{% url 'insumo:mapa_por_sem_ref__get' '00000' %}'.replace('00000', refs[iRefAjax]),
      data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
      success : function(data) {
        if (data) {
          var tr = document.createElement('tr');
          tr.id = 'rec_'+refs[iRefAjax];
          tr.innerHTML = (data);
          dtbRefs.appendChild(tr);
        }
      }
    });
    if (iRefAjax < refs.length) {
      iRefAjax++;
      setTimeout(function(){ doAjax1Ref(); }, 0);
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
      // alert("Ready!");
      // setTimeout(function(){ alert("setTimeout"); }, 3000);
      if (dtbRefs) {
        setTimeout(function(){ doAjax1Ref(); }, 0);
      }
      for (var i = 0, l = refs.length; i < l; i++) {
        var rec = document.getElementById('ref_'+refs[i]);
        var ref = rec.getElementsByClassName('field_ref')[0];
        var data = rec.getElementsByClassName('field_data')[0];
        data.innerHTML = ref.innerHTML;
      }

      for (var i = 90, l = refs.length; i < l; i++) {
        $.ajax({
          type: 'GET',
          url: '{% url 'insumo:mapa_por_sem_ref__get' '00000' %}'.replace('00000', refs[i]),
          data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
          success : function(data) {
            if (data) {
              var tr = document.createElement('tr');
              tr.id = 'rec_'+refs[i];
              tr.innerHTML = (data);
              dtbRefs.appendChild(tr);
            }
          }
        });
        // sleep(2000);
      }

  }, false);

</script>
{% endblock %}
